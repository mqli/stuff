<!DOCTYPE html>
<html>
  <head>
    <title>DC demo</title>
    <script src="http://libs.baidu.com/jquery/1.9.0/jquery.min.js"></script>
    <script src="http://libs.baidu.com/underscore/1.3.3/underscore-min.js"></script>
    <script src="http://libs.baidu.com/backbone/0.9.2/backbone-min.js"></script>
    <script src="http://libs.baidu.com/bootstrap/2.0.4/js/bootstrap.min.js"></script>
    <link href="http://libs.baidu.com/bootstrap/2.0.4/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script id="app-view" type="text/template">
      <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="brand" href="#">DC DEMO</a>
            <ul class="nav">
              <%_.forEach(menus, function (menu) {%>
                <%if (_.isArray(menu.menus) && menu.menus.length > 0) {%>
                  <li class="dropdown">
                    <a class="dropdown-toggle" id="<%=menu.id%>" href="###"><%=menu.text%>
                      <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                      <%_.forEach(menu.menus, function (menu) {%>
                        <li><a class="menu" id="<%=menu.id%>" href="###"><%=menu.text%></a></li>
                      <%})%>
                    </ul>
                  </li>
                <%} else {%>
                <li class=""><a class="menu" id="<%=menu.id%>" href="###"><%=menu.text%></a></li>
              <%}})%>
            </ul>
          </div>
        </div>
      </div>
      <div id="report" class="container-fluid">
        <div id="chart-container" class="row-fluid"></div>
      </div>
    </script>
    <script id="report-view" type="text/template">
      <div class="row-fluid">
        <div id="filter-container" class="span2 row-fluid"></div>
        <div class="span10">
          <div id="chart-container" class="row-fluid"></div>
          <div id="table-container" class="row-fluid"></div>
        </div>
      </div>
    </script>
    <script id="table-view" type="text/template">
      <table class="table table-bordered">
        <thead>
          <tr>
            <%_.forEach(clumns, function (clumn) {%>
              <th><%=clumn.text%></th>
            <%})%>
          </tr>
        </thead>
        <tbody>
          <%_.forEach(records, function (record) {%>
            <tr>
              <%_.forEach(clumns, function (clumn) {%>
                <td>
                  <%if (clumn.subTable) {%>
                    <a class="sub-table" subTable="<%=clumn.subTable%>" href="###"><%=record[clumn.key]%></a>
                  <%} else {%>
                    <%=record[clumn.key]%>
                  <%}%>
                </td>
              <%})%>
            </tr>
          <%})%>
        </tbody>
      </table>
    </script>
    <script id="filter-view" type="text/template">
      <label>
        <%=clumn%>
        <%if (type == "radio") {%>
          <%_.forEach(options, function (option) {%>
            <label class="radio">
              <input type="radio" name="<%=clumn%>"  value="<%=option.value%>">
              <%=option.text%>
            </label>
          <%})%>
        <%}%>
      </label>
    </script>
    <script id="chart-view" type="text/template">
      <div class="chart-container"></div>
    </script>
    <script type="text/javascript" src="MOCK.js"></script>
    <script type="text/javascript">
      $(function () {
        var TableView = Backbone.View.extend({
          tagName: 'div',
          events: {
            'click a.sub-table': 'subTable'
          },
          initialize: function () {
            this.template = _.template($('#table-view').text());
          },
          subTable: function (event) {
            var subTable = MOCK[$(event.target).attr('subTable')];
            $(event.target).removeClass('sub-table');
            new TableView({
              model: new Backbone.Model({
                clumns: subTable.clumns,
                records: subTable.records
              })
            }).render().$el.wrap('<tr><td colspan='+this.model.get('clumns').length+'>').parents('tr').insertAfter($(event.target).parent().parent());
          },
          render: function () {
            this.$el.html(this.template(this.model.toJSON()));
            return this;
          }
        });
        var ChartView = Backbone.View.extend({
          tagName: 'div',
          initialize: function () {
            this.template = _.template($('#chart-view').text());
          },
          render: function () {
            this.$el.html(this.template()).addClass('span5').find('.chart-container').highcharts({
              chart: {
                type: this.model.get('type'),
              },
              title: {
                text: this.model.get('title')
              },
              yAxis:{
                title: {
                  text: this.model.get('yAxisText')
                }
              },
              xAxis: {
                categories: _.pluck(this.model.get('records'), this.model.get('xAxis'))
              },
              series: _.map(this.model.get('clumns'), function (clumn) {
                return {
                  name: clumn,
                  color: this.model.get('color'),
                  data: _.pluck(this.model.get('records'), clumn),
                };
              }, this)
            });
            return this;
          }
        });
        var FilterView = Backbone.View.extend({
          tagName: 'div',
          initialize: function () {
            this.template = _.template($('#filter-view').text());
          },
          render: function () {
            this.$el.html(this.template(this.model.toJSON()));
            return this;
          }
        });
        var Report = Backbone.Model.extend({
          defaults: {
            clumns: [],
            charts: [],
            records: []
          },
          initialize: function () {},
          load: function () {
            var result = MOCK['report_' + this.get('id')];
            this.set('clumns', result.clumns);
            this.set('filters', result.filters.map(function(filter){
              return new Backbone.Model(filter);
            }));
            this.set('charts', result.charts.map(function(chart){
              return new Backbone.Model(chart);
            }));
            this.set('records',result.records);
            this.trigger('loaded');
          }
        });
        var ReportView = Backbone.View.extend({
          initialize: function () {
            this.template = _.template($('#report-view').text());
            this.render();
            this.model.on('loaded', this.renderTable, this);
          },
          renderTable: function () {
            this.$el.find('#table-container').append(new TableView({
              model: new Backbone.Model({
                clumns: this.model.get('clumns'),
                records: this.model.get('records')
              })
            }).render().el);
            this.renderChart();
            this.renderFilter();
          },
          renderChart: function () {
            this.model.get('charts').forEach(function (chart) {
              chart.set('records', this.model.get('records'))
              this.$el.find('#chart-container').append(new ChartView({
                model: chart
              }).render().$el);
            }, this);
          },
          renderFilter: function () {
            this.model.get('filters').forEach(function (filter) {
              this.$el.find('#filter-container').append(new FilterView({
                model: filter
              }).render().$el);
            }, this);
          },
          render: function () {
            this.$el.html(this.template());
          }          
        });
        var App = Backbone.Model.extend({
          initialize: function () {
          }
        });
        var AppView = Backbone.View.extend({
          initialize: function () {
            this.template = _.template($('#app-view').text());
            this.model.on('change:config', this.render, this);
          },
          events: {
            'click a.menu': 'onMenuClick'
          },
          render: function () {
            this.$el.html(this.template(this.model.get('config'))).find('a.dropdown-toggle').dropdown();
          },
          onMenuClick: function (event) {
            var report = new Report({
              id: event.target.id
            }), reportView = new ReportView({
              model: report,
              el: this.$el.find('#report')
            });
            report.load();
          }
        });
        var app = new App(),
          appView = new AppView({
            model:app,
            el: $(document.body)
          });
        app.set('config', MOCK.config);
      });
    </script>
  </head>
  <body style='padding-top: 40px;'></body>
</html>