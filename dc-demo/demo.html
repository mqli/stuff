<!DOCTYPE html>
<html>
  <head>
    <title>DC demo</title>
    <script src="http://libs.baidu.com/jquery/1.9.0/jquery.min.js"></script>
    <script src="http://libs.baidu.com/underscore/1.3.3/underscore-min.js"></script>
    <script src="http://libs.baidu.com/backbone/0.9.2/backbone-min.js"></script>
    <script src="http://libs.baidu.com/bootstrap/2.0.4/js/bootstrap.min.js"></script>
    <link href="http://libs.baidu.com/bootstrap/2.0.4/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script id="app-view" type="text/template">
      <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="brand" href="#">DC DEMO</a>
          </div>
        </div>
      </div>
      <div  class="row-fluid">
        <div id="" class="span2">
          <ul class="nav nav-tabs nav-stacked">
            <%_.forEach(menus, function (menu) {%>
              <%if (_.isArray(menu.menus) && menu.menus.length > 0) {%>
                <li class="">
                  <a class="" id="<%=menu.id%>" href="###"><%=menu.text%></a>
                  <ul class="nav nav-tabs nav-stacked">
                    <%_.forEach(menu.menus, function (menu) {%>
                      <li><a class="menu" id="<%=menu.id%>" reportid="<%=menu.id%>" href="###"><%=menu.text%></a></li>
                    <%})%>
                  </ul>
                </li>
              <%} else {%>
              <li class=""><a class="menu" id="<%=menu.id%>" reportid="<%=menu.id%>" href="###"><%=menu.text%></a></li>
            <%}})%>
          </ul>
        </div>
        <div id="" class="span10">
          <div id="tab-container" class="row-fluid">
            <ul class="nav nav-tabs">
              
            </ul>
          </div>
          <div id="report" class="row-fluid">
          </div>
        </div>
      </div>
    </script>
    <script id="report-view" type="text/template">
      <div id="filter-container" class="row-fluid form-inline"></div>
      <div class="row-fluid">
        <div class="span12">
          <div id="chart-container" class="row-fluid"></div>
          <div id="table-container" class="row-fluid"></div>
        </div>
      </div>
    </script>
    <script id="table-view" type="text/template">
      <table class="table table-bordered">
        <thead>
          <tr>
            <%_.forEach(clumns, function (clumn) {%>
              <th>
                <%=clumn.text%>
                <%if (!_.isEmpty(clumn.tip)) {%>
                  <a href="###" data-placement="bottom" data-title="<%=clumn.text%>" data-content="<%=clumn.tip%>" class="tip icon-question-sign pull-right"></a>
                <%}%>
                <%if (clumn.sortable) {%>
                  <a href="###" sortBy="<%=clumn.key%>" class="sortable icon-arrow-up pull-right"></a>
                <%}%>
              </th>
            <%})%>
          </tr>
        </thead>
        <tbody>
          <%_.forEach(records, function (record) {%>
            <tr>
              <%_.forEach(clumns, function (clumn) {%>
                <td>
                  <%if (clumn.subTable) {%>
                    <a class="sub-table" subTable="<%=clumn.subTable%>" href="###"><%=record[clumn.key]%></a>
                  <%} else {%>
                    <%=record[clumn.key]%>
                  <%}%>
                </td>
              <%})%>
            </tr>
          <%})%>
        </tbody>
      </table>
    </script>
    <script id="filter-view" type="text/template">
      <label>
        <%=clumn%>
        <%if (type == "radio") {%>
          <%_.forEach(options, function (option) {%>
            <label class="radio">
              <input type="radio" name="<%=clumn%>"  value="<%=option.value%>">
              <%=option.text%>
            </label>
          <%})%>
        <%}%>
      </label>
    </script>
    <script id="chart-view" type="text/template">
      <div class="chart-container span12"></div>
    </script>
    <script type="text/javascript" src="MOCK.js"></script>
    <script type="text/javascript">
      $(function () {
        var TableView = Backbone.View.extend({
          tagName: 'div',
          events: {
            'click a.sub-table': 'subTable',
            'click a.toggle-table': 'toggleTable',
            'click a.sortable': 'sort'
          },
          initialize: function () {
            this.template = _.template($('#table-view').text());
          },
          subTable: function (event) {
            var subTable = MOCK[$(event.target).attr('subTable')];
            new TableView({
              model: new Backbone.Model({
                clumns: subTable.clumns,
                records: subTable.records
              })
            }).render().$el.wrap('<tr class="subtable"><td colspan='+this.model.get('clumns').length+'>').parents('tr').insertAfter($(event.target).parent().parent());
            $(event.target).removeClass('sub-table').addClass('toggle-table');
            event.stopPropagation();
          },
          toggleTable: function (event) {
            event.stopPropagation();
            $(event.target).parent().parent().next('tr.subtable').toggle();
          },
          sort: function (event) {
            event.stopPropagation();
            var index =  $(event.target).parents('th').index(),
              desc = $(event.target).attr('desc');
              $(event.target).attr('desc', desc ? '' : 'true').toggleClass('icon-arrow-up').toggleClass('icon-arrow-down');
             $(event.target).parents('table:eq(0)').find('tbody').append(function () {
              $(this).find('tr.subtable').remove();
              return $(this).find('tr').toArray().sort(function (tr1, tr2) {
                var sort = tr1.children[index].innerText > tr2.children[index].innerText;
                return desc ? !sort : sort;
              });
            });
          },
          render: function () {
            this.$el.html(this.template(this.model.toJSON())).
              find('th a.tip').popover({
              });
            return this;
          }
        });
        var ChartView = Backbone.View.extend({
          tagName: 'div',
          initialize: function () {
            this.template = _.template($('#chart-view').text());
          },
          render: function () {
            this.$el.html(this.template()).addClass('row-fluid').find('.chart-container').highcharts({
              chart: {
                type: this.model.get('type'),
                marginRight: 0
              },
              title: {
                text: this.model.get('title')
              },
              yAxis:{
                title: {
                  text: this.model.get('yAxisText')
                }
              },
              xAxis: {
                categories: _.pluck(this.model.get('records'), this.model.get('xAxis'))
              },
              series: _.map(this.model.get('clumns'), function (clumn) {
                return {
                  name: clumn,
                  color: this.model.get('color'),
                  data: _.pluck(this.model.get('records'), clumn),
                };
              }, this)
            });
            return this;
          }
        });
        var FilterView = Backbone.View.extend({
          tagName: 'div',
          initialize: function () {
            this.template = _.template($('#filter-view').text());
          },
          render: function () {
            this.$el.html(this.template(this.model.toJSON()));
            return this;
          }
        });
        var Report = Backbone.Model.extend({
          defaults: {
            clumns: [],
            charts: [],
            records: []
          },
          initialize: function () {},
          load: function () {
            var result = MOCK['report_' + this.get('id')];
            this.set('clumns', result.clumns);
            this.set('filters', result.filters.map(function(filter){
              return new Backbone.Model(filter);
            }));
            this.set('charts', result.charts.map(function(chart){
              return new Backbone.Model(chart);
            }));
            this.set('records',result.records);
            this.trigger('loaded');
          }
        });
        var ReportView = Backbone.View.extend({
          initialize: function () {
            this.template = _.template($('#report-view').text());
            this.render();
            this.model.on('loaded', this.renderTable, this);
          },
          renderTable: function () {
            this.$el.find('#table-container').append(new TableView({
              model: new Backbone.Model({
                clumns: this.model.get('clumns'),
                records: this.model.get('records')
              })
            }).render().el);
            this.renderChart();
            this.renderFilter();
          },
          renderChart: function () {
            this.model.get('charts').forEach(function (chart) {
              chart.set('records', this.model.get('records'))
              this.$el.find('#chart-container').append(new ChartView({
                model: chart
              }).render().$el);
            }, this);
          },
          renderFilter: function () {
            this.model.get('filters').forEach(function (filter) {
              this.$el.find('#filter-container').append(new FilterView({
                model: filter
              }).render().$el);
            }, this);
          },
          render: function () {
            this.$el.html(this.template());
          }          
        });
        var App = Backbone.Model.extend({
          initialize: function () {
          }
        });
        var AppView = Backbone.View.extend({
          initialize: function () {
            this.template = _.template($('#app-view').text());
            this.model.on('change:config', this.render, this);
          },
          events: {
            'click a.menu': 'onMenuClick'
          },
          render: function () {
            this.$el.html(this.template(this.model.get('config')));
          },
          onMenuClick: function (event) {
            var reportid = $(event.target).attr('reportid'),
                report = new Report({
                  id: reportid
                }),
                reportView = new ReportView({
                  model: report,
                  el: this.$el.find('#report')
                });
            $('#tab-container ul').children().removeClass('active');
            if ($('#tab_'+reportid).length > 0) {
              $('#tab_'+reportid).addClass('active');
            } else {
              $('#tab-container ul').append('<li id="tab_' + reportid+ '"   class="active"><a class="menu" href="###" reportid="'+reportid+'">'+event.target.innerText+'</a></li>');
            }
            report.load();
          }
        });
        var app = new App(),
          appView = new AppView({
            model:app,
            el: $(document.body)
          });
        app.set('config', MOCK.config);
      });
    </script>
  </head>
  <body style='padding-top: 40px;'></body>
</html>